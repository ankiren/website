---
title: "US-6.8: Bulk Score Import"
epic: Skill Management
status: Planned
priority: Low
github_issue: ""
---

# US-6.8: Bulk Score Import

## Description

As a **user**,
I want to **import multiple scores at once from a file**,
So that **I can quickly add historical data or batch assessment results**.

---

## Acceptance Criteria

| AC | Title | Description |
|----|-------|-------------|
| AC-6.8.1 | Download Template | User can download import template |
| AC-6.8.2 | Upload File | User can upload CSV file with scores |
| AC-6.8.3 | Validation Preview | User sees validation before import |
| AC-6.8.4 | Import Execution | Scores are imported with progress |

---

### AC-6.8.1: Download Template

```gherkin
Scenario: Download CSV template
  Given I am logged in as a user
  And I am on the import scores page
  When I click "Download Template"
  Then a CSV file should be downloaded
  And the file should have headers:
    | skill_name | score | source | note | date |
  And the file should include example rows

Scenario: Template includes my skills
  Given I am tracking skills: Reading, Listening, Writing
  When I download the template
  Then the template should include my skill names as examples
```

### AC-6.8.2: Upload File

```gherkin
Scenario: Upload valid CSV file
  Given I have a CSV file with scores:
    | skill_name | score | source   | note            | date       |
    | Reading    | 75    | test     | IELTS test      | 2025-12-01 |
    | Reading    | 80    | practice | Daily practice  | 2025-12-05 |
    | Listening  | 60    | test     | Mock test       | 2025-12-01 |
  When I upload the file
  Then the file should be accepted
  And I should see a validation preview

Scenario: Upload invalid file format
  Given I have an Excel file instead of CSV
  When I try to upload the file
  Then I should see an error "Please upload a CSV file"

Scenario: File size limit
  Given I have a CSV file larger than 1MB
  When I try to upload the file
  Then I should see an error "File size must be less than 1MB"
```

### AC-6.8.3: Validation Preview

```gherkin
Scenario: Preview valid entries
  Given I uploaded a CSV with 10 valid entries
  When I see the validation preview
  Then I should see "10 entries ready to import"
  And I should see a table preview of the data
  And each row should show skill, score, source, date

Scenario: Preview with errors
  Given I uploaded a CSV with some invalid entries:
    | Row | Error                              |
    | 3   | Score 150 exceeds maximum (100)    |
    | 5   | Skill "Math" not found             |
    | 7   | Invalid source "exam"              |
  When I see the validation preview
  Then I should see "7 valid, 3 errors"
  And invalid rows should be highlighted in red
  And I should see the error message for each invalid row

Scenario: All entries invalid
  Given I uploaded a CSV where all entries are invalid
  When I see the validation preview
  Then I should see "0 valid entries"
  And I should not be able to proceed with import
  And I should see "Fix errors and try again"

Scenario: Skill not being tracked
  Given my CSV includes a skill I'm not tracking
  When I see the validation preview
  Then I should see warning "Skill will be added to your tracking"
  And I should be able to proceed
```

### AC-6.8.4: Import Execution

```gherkin
Scenario: Import valid entries
  Given I have previewed 10 valid entries
  When I click "Import" button
  Then I should see a progress indicator
  And scores should be imported one by one
  And I should see "10 of 10 imported" when complete
  And I should see a success message

Scenario: Import with skipped errors
  Given I have 7 valid and 3 invalid entries
  When I click "Import Valid Only"
  Then the 7 valid entries should be imported
  And the 3 invalid entries should be skipped
  And I should see "7 imported, 3 skipped"

Scenario: Import updates current scores
  Given I import a score for "Reading"
  And the imported date is more recent than my last assessment
  When the import completes
  Then my current score for "Reading" should be updated
  And my last_assessed_at should reflect the import date

Scenario: Cancel import
  Given the import is in progress
  When I click "Cancel"
  Then the import should stop
  And already imported entries should remain
  And I should see "Import cancelled: 5 of 10 imported"
```

---

## Technical Notes

### Implementation
- **Page**: `src/app/dashboard/skills/import/page.tsx` - Import page
- **API**: `src/app/api/me/skills/import/route.ts` - Import endpoint
- **Component**: `src/components/BulkImport.tsx` - Import wizard

### CSV Format
```csv
skill_name,score,source,note,date
Reading,75,test,IELTS practice test,2025-12-01
Reading,80,practice,Daily exercises,2025-12-05
Listening,60,test,Mock test,2025-12-01
```

### Validation Rules
| Field | Rule |
|-------|------|
| skill_name | Must match existing skill name |
| score | Number between 0 and 100 |
| source | One of: test, practice, assessment |
| note | Optional, max 500 characters |
| date | Valid date in YYYY-MM-DD format, not future |

### Database
```sql
-- Bulk insert with transaction
BEGIN TRANSACTION;

-- For each valid row:
-- 1. Ensure skill is being tracked
INSERT OR IGNORE INTO Users_Skills (id, user_id, skill_id, current_score, last_assessed_at)
SELECT uuid(), :userId, id, NULL, NULL FROM Skills WHERE name = :skillName;

-- 2. Add history entry
INSERT INTO Users_Skills_History (id, user_skill_id, score, source, note, created_at)
SELECT uuid(), us.id, :score, :source, :note, :date
FROM Users_Skills us
JOIN Skills s ON us.skill_id = s.id
WHERE us.user_id = :userId AND s.name = :skillName;

-- 3. Update current score if this is the most recent
UPDATE Users_Skills
SET current_score = :score, last_assessed_at = :date
WHERE user_id = :userId AND skill_id = (SELECT id FROM Skills WHERE name = :skillName)
  AND (last_assessed_at IS NULL OR last_assessed_at < :date);

COMMIT;
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/me/skills/import/template` | Download template |
| POST | `/api/me/skills/import/validate` | Validate CSV |
| POST | `/api/me/skills/import` | Execute import |

### Request/Response Format
```json
// POST /api/me/skills/import/validate
// Body: FormData with file

// Response
{
  "valid": [
    { "row": 1, "skillName": "Reading", "score": 75, "source": "test", "date": "2025-12-01" }
  ],
  "errors": [
    { "row": 3, "field": "score", "message": "Score 150 exceeds maximum (100)" }
  ],
  "summary": {
    "total": 10,
    "valid": 7,
    "errors": 3
  }
}

// POST /api/me/skills/import
{
  "entries": [
    { "skillName": "Reading", "score": 75, "source": "test", "note": "IELTS", "date": "2025-12-01" }
  ]
}

// Response
{
  "imported": 7,
  "skipped": 3,
  "errors": [
    { "row": 3, "error": "Skill not found" }
  ]
}
```

---

## RICE Score

| Factor | Value | Rationale |
|--------|-------|-----------|
| Reach | 20% | Power users with historical data |
| Impact | 1 (Low) | Convenience feature |
| Confidence | 60% | Complex validation logic |
| Effort | 1 week | File parsing + validation + UI |

**Score:** (20 × 1 × 0.6) / 1 = **12**
