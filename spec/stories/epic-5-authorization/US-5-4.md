---
title: "US-5.4: Access Control"
epic: Authorization
status: Planned
priority: Critical
github_issue: ""
---

# US-5.4: Access Control

## Description

As a **system**,
I want to **enforce access control based on user permissions**,
So that **users can only access features they are authorized to use**.

---

## Acceptance Criteria

### AC-5.4.1: API Access Control

```gherkin
Scenario: Access API with required permission
  Given I am logged in as a user with "manage_users" permission
  When I call GET "/api/users"
  Then I should receive the list of users
  And the response status should be 200

Scenario: Access API without required permission
  Given I am logged in as a user without "manage_users" permission
  When I call GET "/api/users"
  Then I should receive an error response
  And the response status should be 403
  And the error message should be "Access denied"
```

### AC-5.4.2: UI Access Control

```gherkin
Scenario: View admin menu with admin permissions
  Given I am logged in as an Admin
  When I view the navigation menu
  Then I should see the "Admin" section
  And I should see links to "Users", "Roles", and "Settings"

Scenario: Hide admin menu without admin permissions
  Given I am logged in as a regular User
  When I view the navigation menu
  Then I should not see the "Admin" section
```

### AC-5.4.3: Page Access Control

```gherkin
Scenario: Access admin page with permission
  Given I am logged in as an Admin
  When I navigate to "/dashboard/admin/users"
  Then I should see the user management page

Scenario: Access admin page without permission
  Given I am logged in as a regular User
  When I navigate to "/dashboard/admin/users"
  Then I should be redirected to "/dashboard"
  And I should see an error message "Access denied"
```

### AC-5.4.4: Feature Access Control

```gherkin
Scenario: Show action button with permission
  Given I am logged in with "manage_own_skills" permission
  When I view my skills page
  Then I should see "Add Skill" button
  And I should see "Edit" and "Delete" buttons for each skill

Scenario: Hide action button without permission
  Given I am logged in as a "User" without "manage_own_skills" permission
  When I view the skills page
  Then I should not see "Add Skill" button
  And I should not see "Edit" or "Delete" buttons
```

### AC-5.4.5: Current User Permissions

```gherkin
Scenario: Get current user permissions
  Given I am logged in
  When I call GET "/api/me/permissions"
  Then I should receive my list of permissions
  And the permissions should be combined from all my roles
```

### AC-5.4.6: Permission Caching

```gherkin
Scenario: Permissions are included in session
  Given I am logged in
  Then my permissions should be available in the JWT session
  And permission checks should not require database queries
```

---

## Technical Notes

### Implementation
- **Middleware**: `src/lib/rbac.ts` - RBAC middleware and helpers
- **Hook**: `src/hooks/usePermissions.ts` - Client-side permission hook
- **Component**: `src/components/PermissionGate.tsx` - Conditional rendering

### RBAC Middleware
```typescript
// src/lib/rbac.ts
export function requirePermission(permission: string) {
  return async (req: Request) => {
    const session = await auth();
    if (!session?.user?.permissions?.includes(permission)) {
      return new Response('Access denied', { status: 403 });
    }
  };
}

export function hasPermission(session: Session, permission: string): boolean {
  return session?.user?.permissions?.includes(permission) ?? false;
}
```

### Session Extension
```typescript
// Extend NextAuth session to include permissions
interface Session {
  user: {
    id: string;
    email: string;
    roles: string[];
    permissions: string[];
  }
}
```

### Permission Gate Component
```typescript
// src/components/PermissionGate.tsx
export function PermissionGate({
  permission,
  children,
  fallback
}: Props) {
  const { hasPermission } = usePermissions();
  if (!hasPermission(permission)) return fallback ?? null;
  return children;
}
```

### API Protection Example
```typescript
// src/app/api/users/route.ts
export async function GET(req: Request) {
  const error = await requirePermission('manage_users')(req);
  if (error) return error;

  // ... handle request
}
```

### Error Handling
| Error | HTTP Status | Message |
|-------|-------------|---------|
| Not authenticated | 401 | "Please log in" |
| No permission | 403 | "Access denied" |

---

## RICE Score

| Factor | Value | Rationale |
|--------|-------|-----------|
| Reach | 30% | Affects users trying to access restricted features |
| Impact | 3 (Massive) | Core security feature |
| Confidence | 80% | Standard middleware patterns |
| Effort | 1 week | Middleware + UI integration |

**Score:** (30 × 3 × 0.8) / 1 = **72**
