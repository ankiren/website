---
title: "US-5.2: User Role Assignment"
epic: Authorization
status: Planned
priority: Critical
github_issue: ""
---

# US-5.2: User Role Assignment

## Description

As an **administrator**,
I want to **assign and remove roles from users**,
So that **I can control what each user can access in the system**.

---

## Acceptance Criteria

### AC-5.2.1: View User Roles

```gherkin
Scenario: View roles assigned to a user
  Given I am logged in as an Admin
  When I navigate to user details page
  Then I should see all roles assigned to that user
  And I should see when each role was assigned
  And I should see who assigned the role
```

### AC-5.2.2: Assign Role to User

```gherkin
Scenario: Assign a role to a user
  Given I am logged in as an Admin
  And I am viewing user "john@example.com"
  When I click "Assign Role" button
  And I select role "Manager"
  And I click "Confirm"
  Then the "Manager" role should be assigned to the user
  And I should see a success message
  And the role should appear in the user's role list

Scenario: Assign already assigned role
  Given I am logged in as an Admin
  And user "john@example.com" already has "Manager" role
  When I try to assign "Manager" role again
  Then I should see a message "User already has this role"
  And no duplicate role should be created
```

### AC-5.2.3: Remove Role from User

```gherkin
Scenario: Remove a role from a user
  Given I am logged in as an Admin
  And user "john@example.com" has "Manager" role
  When I click the remove button for "Manager" role
  And I confirm the removal
  Then the "Manager" role should be removed from the user
  And I should see a success message

Scenario: Cannot remove last Admin role
  Given I am logged in as an Admin
  And I am the only user with "Admin" role
  When I try to remove my own "Admin" role
  Then I should see an error message "Cannot remove the last admin"
  And the role should not be removed
```

### AC-5.2.4: Multiple Roles

```gherkin
Scenario: User can have multiple roles
  Given I am logged in as an Admin
  And user "john@example.com" has "User" role
  When I assign "Manager" role to the user
  Then the user should have both "User" and "Manager" roles
  And the user should have combined permissions from both roles
```

### AC-5.2.5: First User Admin Assignment

```gherkin
Scenario: First user is automatically Admin
  Given no users exist in the system
  When the first user registers
  Then that user should automatically be assigned the "Admin" role
  And that user should have full system access
```

---

## Technical Notes

### Implementation
- **Page**: `src/app/dashboard/admin/users/[id]/page.tsx` - User detail page
- **API**: `src/app/api/users/[id]/roles/route.ts` - Role assignment endpoints
- **Component**: `src/components/UserRoleAssignment.tsx` - Role assignment UI

### Database
```sql
-- Assign role to user
INSERT INTO UserRole (id, userId, roleId, assignedBy, createdAt)
VALUES (cuid(), ?, ?, currentUserId, now);

-- Remove role from user
DELETE FROM UserRole WHERE userId = ? AND roleId = ?;

-- Check if last admin
SELECT COUNT(*) FROM UserRole WHERE roleId = (SELECT id FROM Role WHERE name = 'Admin');
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/users/:id/roles` | Get user's roles |
| POST | `/api/users/:id/roles` | Assign role to user |
| DELETE | `/api/users/:id/roles/:roleId` | Remove role from user |

### Error Handling
| Error | HTTP Status | Message |
|-------|-------------|---------|
| User not found | 404 | "User not found" |
| Role not found | 404 | "Role not found" |
| Already assigned | 409 | "User already has this role" |
| Last admin | 403 | "Cannot remove the last admin" |

---

## RICE Score

| Factor | Value | Rationale |
|--------|-------|-----------|
| Reach | 30% | Only admins use this feature |
| Impact | 3 (Massive) | Critical for access control |
| Confidence | 80% | Simple assignment logic |
| Effort | 0.5 week | Simple CRUD + validation |

**Score:** (30 × 3 × 0.8) / 0.5 = **144**
