---
title: "US-1.2: User Login with Google"
epic: User Authentication
status: In Progress
priority: Critical
github_issue: https://github.com/ankiren/website/issues/2
---

# US-1.2: User Login with Google

## Description

As a **registered user**,
I want to **login using my Google account**,
So that **I can access my flashcards and continue learning**.

---

## Acceptance Criteria

### AC-1.2.1: Login Page Access

```gherkin
Scenario: Access login page
  Given I am not logged in
  When I navigate to "/login"
  Then I should see the login page
  And I should see a "Continue with Google" button
  And I should see a link to navigate to the registration page
```

### AC-1.2.2: Successful Google Login

```gherkin
Scenario: Successful login with Google
  Given I am not logged in
  And I have an existing account with Google email
  And I am on the login page "/login"
  When I click the "Continue with Google" button
  Then I should be redirected to Google OAuth consent screen

Scenario: Complete Google login authorization
  Given I am on the Google OAuth consent screen
  When I authorize Ankiren to access my Google profile
  Then a JWT session should be created
  And a HTTP-only cookie should be set
  And I should be redirected to the dashboard "/dashboard"
```

### AC-1.2.3: Auto-Registration on Login

```gherkin
Scenario: Login with new Google account triggers auto-registration
  Given I am not logged in
  And I do not have an existing account
  And I am on the login page "/login"
  When I click the "Continue with Google" button
  And I authorize Ankiren to access my Google profile
  Then a new account should be created with my Google email
  And I should be redirected to the dashboard "/dashboard"
```

### AC-1.2.4: Account Linking

```gherkin
Scenario: Link existing account with Google
  Given I have an existing account with email "user@example.com"
  And my account is not linked to Google
  When I login with Google using the same email
  Then my account should be linked to my Google account
  And my name should be updated from Google
  And my profile picture should be updated from Google
```

### AC-1.2.5: Error Handling

```gherkin
Scenario: Google authentication cancelled
  Given I am on the login page "/login"
  When I click the "Continue with Google" button
  And I cancel the Google OAuth consent
  Then I should be returned to the login page
  And I should see an error message

Scenario: Google authentication fails
  Given I am on the login page "/login"
  When I click the "Continue with Google" button
  And Google authentication fails
  Then I should see an error message "Authentication failed"
  And I should remain on the login page
```

### AC-1.2.6: Post-Login UI State (Pending)

```gherkin
Scenario: Home page UI when logged in
  Given I am logged in
  When I visit the home page "/"
  Then I should not see the "Sign In" button in the hero section
  And I should not see the "Start Learning Free" button in the hero section

Scenario: Navigation bar when logged in
  Given I am logged in
  When I view the navigation bar
  Then I should see a "Dashboard" link
  And I should see my email address
  And I should see a "Sign Out" button
  And I should not see any "Sign In" links

Scenario: Navigation bar when not logged in
  Given I am not logged in
  When I view the navigation bar
  Then I should see a "Sign In" link
  And I should not see a "Dashboard" link
  And I should not see a "Sign Out" button
```

### AC-1.2.7: Navigation

```gherkin
Scenario: Navigate to registration page
  Given I am on the login page "/login"
  When I click the "Create account" link
  Then I should be redirected to the registration page "/register"
```

---

## Technical Notes

### Implementation
- **Auth Config**: `src/lib/auth.ts` - Google OAuth provider
- **Page**: `src/app/login/page.tsx` - Login page with Google button
- **Handler**: `src/app/api/auth/[...nextauth]/route.ts`
- **Home Page**: `src/app/page.tsx` - Conditional rendering based on session
- **Navbar**: `src/components/Navbar.tsx` - Show/hide buttons based on auth state

### Authentication Flow
```
User clicks "Continue with Google" on /login
    ↓
Redirect to Google OAuth consent screen
    ↓
User authorizes access
    ↓
Google redirects to /api/auth/callback/google
    ↓
NextAuth processes callback
    ↓
Query D1 for user by email or googleId
    ↓
Return user object
    ↓
Generate JWT session
    ↓
Set HTTP-only cookie
    ↓
Redirect to /dashboard
```

### Session Structure
```typescript
{
  user: {
    id: string,
    email: string,
    name: string | null,
    image: string | null
  },
  expires: string // ISO date
}
```

### Error Handling
| Error | Behavior |
|-------|----------|
| Google auth cancelled | Return to login page |
| Google auth error | Show error message |
| User not found | Auto-register and login |

---

## RICE Score

| Factor | Value | Rationale |
|--------|-------|-----------|
| Reach | 100% | All users need to login |
| Impact | 3 (Massive) | Required for access |
| Confidence | 100% | NextAuth.js has built-in Google support |
| Effort | 0.5 week | NextAuth handles complexity |

**Score:** (100 × 3 × 1.0) / 0.5 = **600**
